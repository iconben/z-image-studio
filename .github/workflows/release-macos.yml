name: macOS Release Build

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'feat/homebrew-workflow'

permissions:
  contents: write
  attestations: write
  id-token: write

env:
  SIGN_IDENTITY: ${{ secrets.APPLE_DEVELOPER_ID }}
  SIGN_ENTITLEMENTS: ${{ secrets.APPLE_SIGN_ENTITLEMENTS_FILE }}

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            version="${GITHUB_REF_NAME#v}"
          else
            version="0.0.0-dev-${GITHUB_SHA::7}"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install project dependencies
        run: |
          uv pip install --system -e .
          uv pip install --system pyinstaller

      - name: Install create-dmg
        run: |
          brew install create-dmg

      - name: Build PyInstaller .app bundle
        run: |
          chmod +x packaging/macos/scripts/build-macos.sh
          ./packaging/macos/scripts/build-macos.sh \
            --version "${{ steps.version.outputs.version }}"

      - name: Verify .app exists
        run: |
          if [ ! -d "dist/Z-Image Studio.app" ]; then
            echo "ERROR: .app bundle not found!"
            exit 1
          fi
          echo ".app bundle found"
          ls -la "dist/Z-Image Studio.app/Contents/MacOS/"

      - name: Verify .dmg exists
        run: |
          version="${{ steps.version.outputs.version }}"
          dmg="dist/Z-Image-Studio-macOS-arm64-${version}.dmg"
          if [ ! -f "$dmg" ]; then
            echo "ERROR: DMG not found at $dmg"
            exit 1
          fi
          echo "DMG found: $(ls -lh "$dmg")"

      - name: Code sign .dmg (optional)
        if: env.SIGN_IDENTITY != ''
        run: |
          version="${{ steps.version.outputs.version }}"
          dmg="dist/Z-Image-Studio-macOS-arm64-${version}.dmg"
          echo "Signing DMG with identity: $SIGN_IDENTITY"
          codesign --sign "$SIGN_IDENTITY" \
            --timestamp \
            --force \
            "$dmg"

      - name: Compute SHA256 checksum
        id: checksum
        run: |
          version="${{ steps.version.outputs.version }}"
          dmg="dist/Z-Image-Studio-macOS-arm64-${version}.dmg"
          sha256=$(shasum -a 256 "$dmg" | cut -d' ' -f1)
          echo "sha256=$sha256" >> $GITHUB_OUTPUT
          echo "Checksum: $sha256"

      - name: Create checksums file
        run: |
          version="${{ steps.version.outputs.version }}"
          dmg="Z-Image-Studio-macOS-arm64-${version}.dmg"
          echo "${{ steps.checksum.outputs.sha256 }}  $dmg" > "dist/${dmg}.sha256"
          cat "dist/${dmg}.sha256"

      - name: Upload all artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/Z-Image-Studio-*.dmg
            dist/*.sha256
          draft: false
          prerelease: false
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Tap
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          if [ -z "$TAP_GITHUB_TOKEN" ]; then
            echo "Skipping Homebrew update because TAP_GITHUB_TOKEN is not set."
            exit 0
          fi

          VERSION="${{ steps.version.outputs.version }}"
          SHA256="${{ steps.checksum.outputs.sha256 }}"

          echo "Updating Homebrew formula for version $VERSION with SHA256 $SHA256..."

          # Clone the tap repository
          git clone https://x-access-token:$TAP_GITHUB_TOKEN@github.com/iconben/homebrew-tap.git homebrew-tap

          # Determine destination path
          if [ -d "homebrew-tap/Casks" ]; then
            DEST_FILE="homebrew-tap/Casks/z-image-studio.rb"
          else
            DEST_FILE="homebrew-tap/z-image-studio.rb"
          fi

          echo "Writing to $DEST_FILE"

          # Read template and substitute variables
          sed -e "s/VERSION_PLACEHOLDER/$VERSION/g" \
              -e "s/SHA256_PLACEHOLDER/$SHA256/g" \
              packaging/macos/homebrew/z-image-studio.rb > "$DEST_FILE"

          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update z-image-studio to $VERSION"
            git push
            echo "Homebrew tap updated successfully."
          fi

      - name: Output signing info
        if: env.SIGN_IDENTITY == ''
        run: |
          echo "=== SIGNING SKIPPED ==="
          echo "No APPLE_DEVELOPER_ID secret set."
          echo "To enable code signing, add APPLE_DEVELOPER_ID to repository secrets."
          echo "The .dmg is unsigned and will show a Gatekeeper warning."
